<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Eye Tracking con WebGazer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #111;
      color: #fff;
      font-family: sans-serif;
    }
    #webgazerVideoFeed {
      position: fixed;
      top: 0;
      left: 0;
      width: 320px; 
      height: 240px;
      transform: scaleX(1); /* espejo ON si pones (-1), OFF si pones (1) */
      border: 2px solid #0f0;
      z-index: 10;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 20;
      pointer-events: none;
    }
    #calibration {
      position: fixed;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      z-index: 30;
    }
    .calibration-point {
      width: 30px;
      height: 30px;
      margin: 40px;
      border-radius: 50%;
      background: red;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="overlay"></canvas>
  
  <!-- Pantalla de calibración -->
  <div id="calibration">
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
    <div class="calibration-point"></div>
  </div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    // --- CONFIGURACIÓN DE WEBGAZER ---
    webgazer.setRegression('ridge') // modelo de predicción
      .setGazeListener((data, elapsedTime) => {
        if (data == null) return;
        let x = data.x;
        let y = data.y;
        drawDot(x, y);
      })
      .begin();

    // --- Ajustar video feed ---
    window.onload = () => {
      const video = document.getElementById('webgazerVideoFeed');
      video.style.transform = "scaleX(-1)"; // espejo: cámbialo a "scaleX(1)" si no quieres espejar
    };

    // --- Dibujo en overlay ---
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    overlay.width = window.innerWidth;
    overlay.height = window.innerHeight;

    function drawDot(x, y) {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      ctx.beginPath();
      ctx.arc(x, y, 10, 0, 2 * Math.PI);
      ctx.fillStyle = 'lime';
      ctx.fill();
    }

    // --- Calibración tipo webgazer ---
    let calibrationPoints = document.querySelectorAll('.calibration-point');
    let calibrationCount = 0;

    calibrationPoints.forEach(point => {
      point.addEventListener('click', () => {
        point.style.background = "green";
        calibrationCount++;
        webgazer.recordScreenPosition(point.offsetLeft, point.offsetTop, 'click');
        if (calibrationCount >= calibrationPoints.length) {
          document.getElementById('calibration').style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
